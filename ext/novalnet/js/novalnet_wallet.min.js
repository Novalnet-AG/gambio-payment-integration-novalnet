/**
 * Novalnet payment module
 *
 * This script is used for wallet payments
 *
 * @author     Novalnet AG
 * @copyright  Copyright (c) Novalnet
 * @license    https://www.novalnet.de/payment-plugins/kostenlos/lizenz
 * @link       https://www.novalnet.de
 *
 * Script: novalnet_wallet.min.js
 */
function show_hide(){jQuery("#checkout_payment").on("click",(function(){"novalnet_applepay"==jQuery('input[name="payment"]:checked').val()||"novalnet_googlepay"==jQuery('input[name="payment"]:checked').val()?jQuery(".continue_button").hide():jQuery(".continue_button").show()}))}function novalnet_wallet_product_page(){1==jQuery("#novalnet_googlepay_enable").val()&&displayWalletButtons("novalnet_googlepay"),1==jQuery("#novalnet_applepay_enable").val()&&displayWalletButtons("novalnet_applepay")}function novalnet_wallet_cart_page(){1==jQuery("#novalnet_googlepay_enable").val()&&displayWalletButtons("novalnet_googlepay"),1==jQuery("#novalnet_applepay_enable").val()&&displayWalletButtons("novalnet_applepay")}function novalnet_checkout_page(e){displayWalletButtons(e)}function displayWalletButtons(e){var a=jQuery("#"+e+"_data").val();a=JSON.parse(a);var t=jQuery("#"+e+"_wallet_div"),n=jQuery("#"+e+"_wallet_button"),o="novalnet_googlepay"==e?"googlepay":"applepay",l=e+"Instance";(l=NovalnetPayment().createPaymentObject()).setPaymentIntent(self.walletPaymentRequest(e,o,a)),l.isPaymentMethodAvailable((function(o){o?(n.empty(),l.addPaymentButton("#"+e+"_wallet_button"),"product_info"==a.current_page?jQuery("#"+e+"_wallet_button").find("apple-pay-button").css({width:"425px","margin-left":"3%"}):"shopping_cart"==a.current_page&&jQuery("#"+e+"_wallet_button").find("apple-pay-button").css({width:"415px","margin-left":"0.5%"}),t.css("display","block")):(t.css("display","none"),jQuery("#novalnet_applepay_checkoutdiv")&&jQuery(".novalnet_applepay").length>0&&jQuery(".novalnet_applepay").hide())}))}function walletPaymentRequest(e,a,t){var n={dimensions:{width:"auto",cornerRadius:"APPLEPAY"==(a=a.toUpperCase())?t.applepay_button_radius:"",height:parseInt("GOOGLEPAY"==a?t.googlepay_button_height:t.applepay_button_height)},locale:void 0!==t.lang?t.lang.toLowerCase()+"-"+t.lang:"",type:"GOOGLEPAY"==a?t.googlepay_button_type:t.applepay_button_type,boxSizing:"GOOGLEPAY"==a?"fill":"border-box"};if("shopping_cart"!=t.current_page||"GOOGLEPAY"!=a&&"APPLEPAY"!=a)o="GOOGLEPAY"==a?jQuery("#nn_googlepay_total_label").val():jQuery("#nn_applepay_total_label").val();else var o="GOOGLEPAY"==a?jQuery("#nn_googlepay_estotal_label").val():jQuery("#nn_applepay_estotal_label").val();var l=["postalAddress","phone","email"];if(0==t.show_shipping_option&&"APPLEPAY"==t.payment_method)l=["email"];var p={clientKey:t.client_key,paymentIntent:{transaction:{amount:void 0!==t.total_amount?t.total_amount:"",currency:void 0!==t.currency?t.currency:"",paymentMethod:a,enforce3d:void 0!==t.enforce_3d?t.enforce_3d:"",environment:void 0!==t.environment?t.environment:"",setPendingPayment:"checkout_payment"!=t.current_page&&"product_info"!=t.current_page},merchant:{countryCode:void 0!==t.country_code?t.country_code:"",partnerId:"GOOGLEPAY"==a&&void 0!==t.partner_id?t.partner_id:"",paymentDataPresent:!1},custom:{lang:void 0!==t.lang?t.lang.toLowerCase()+"-"+t.lang:""},order:{paymentDataPresent:!1,merchantName:void 0!==t.seller_name?t.seller_name:"",lineItems:JSON.parse(jQuery("#nn_article_details").val()),billing:{requiredFields:"checkout_payment"!=t.current_page?["postalAddress","phone","email"]:["postalAddress"]},shipping:{requiredFields:"checkout_payment"!=t.current_page?l:["postalAddress","phone","email"],methodsUpdatedLater:"checkout_payment"!=t.current_page},labelText:o},button:n,callbacks:{onProcessCompletion:function(e,n){if("SUCCESS"==e.result.status)if("checkout_payment"==t.current_page){n({status:"SUCCESS",statusText:""}),"GOOGLEPAY"==a?(document.getElementById("nn_google_wallet").value=e.transaction.token,document.getElementById("nn_wallet_doredirect").value=e.transaction.doRedirect):document.getElementById("nn_wallet").value=e.transaction.token;var o=jQuery("div.continue_button :submit");jQuery(o).click()}else{var l={response:e},p={variable_name:l,payment_name:"GOOGLEPAY"==a?"novalnet_googlepay":"novalnet_applepay",payment_page:void 0!==t.current_page?t.current_page:""};1==t.shop_version&&(p.customer_id=t.customer_id,p.loginUrl=t.login_url,p.shippingPage=t.shipping_page),null!=t.customer_id&&0==t.customer_id&&"product_info"==t.current_page&&(p.products_qty=jQuery("input[name='products_qty']").val(),p.products_id=jQuery("input[name='products_id']").val(),p.product_amount=jQuery("#nn_product").val()),jQuery.ajax({type:"POST",url:"novalnet_wallet_payment_process.php",data:p,success:function(e){1==(l=JSON.parse(e)).isLogin&&l.login_url&&(window.location.replace(l.login_url),window.location.replace(l.shipping_page)),1==l.isRedirect&&l.redirect_url&&window.location.replace(l.redirect_url),l.return_url&&window.location.replace(l.return_url),n({status:"SUCCESS",statusText:""})},error:function(e){n({status:"ERROR",statusText:e.result.statusText})}})}},onShippingContactChange:function(e,t){var n={address:e},o={action:"novalnet_shipping_address_update",shippingInfo:JSON.stringify(n)};("GOOGLEPAY"==a&&jQuery("#novalnet_googlepay_wallet_button")||"APPLEPAY"==a&&jQuery("#novalnet_applepay_wallet_button"))&&(o.products_qty=jQuery("input[name='products_qty']").val(),o.products_id=jQuery("input[name='products_id']").val(),o.product_amount=jQuery("#nn_product").val());var l=[];$("[name*='modifiers[property]']").each((function(){var e=$(this).val();e&&0!=e&&!l.includes(e)&&l.push(e)})),o.variant_info=l,new Promise((function(e,a){jQuery.ajax({type:"POST",url:"novalnet_wallet_shipping_data_update_process.php",data:o,success:function(a){e(a)}})})).then((function(e){var a=JSON.parse(e),n={};0==a.shipping_address.length?n.methodsNotFound="There are no shipping options available. Please ensure that your address has been entered correctly, or contact us if you need any help.":null!=a.shipping_address&&a.shipping_address.length&&(n.amount=a.amount,n.lineItems=a.article_details,n.methods=a.shipping_address,n.defaultIdentifier=a.shipping_address[0].identifier),t(n)}))},onShippingMethodChange:function(e,a){var t={shippingMethod:e},n={action:"novalnet_shipping_method_update",shippingInfo:JSON.stringify(t)};$.ajax({type:"POST",url:"novalnet_wallet_shipping_data_update_process.php",data:n,success:function(e){var t=JSON.parse(e),n={amount:t.amount,lineItems:t.article_details};a(n)}})},onPaymentButtonClicked:function(a){if("product_info"==t.current_page)if(jQuery('button[name="btn-add-to-cart"]').prop("disabled")||jQuery('input[name="btn-add-to-cart"]').prop("disabled"))a({status:"FAILURE"}),alert("Please select some product options before adding this product to your cart.");else if(2==t.product_type){var n={action:"add_virtual_product_in_cart",products_id:jQuery("input[name='products_id']").val(),products_qty:jQuery("input[name='products_qty']").val()},o=[];$("[name*='modifiers[attribute]']").each((function(){if(1==$(this).prop("checked")){var e=$(this).val();e&&0!=e&&!o.includes(e)&&o.push(e)}})),n.attribute_info=o,$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:n,success:function(a){var t=JSON.parse(a);if(""!=t.amount&&void 0!==typeof t.amount){var n=JSON.parse($("#"+e+"_data").val());n.total_amount=parseInt(t.amount),n.orig_amount=parseInt(t.amount),$("#"+e+"_data").val(JSON.stringify(n))}""!=t.article_details&&$("#nn_article_details").val(JSON.stringify(t.article_details))}}),a({status:"SUCCESS"})}else a({status:"SUCCESS"});else{n={action:"updated_amount"};$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:n,success:function(a){var t=JSON.parse(a);if(""!=t.amount&&void 0!==typeof t.amount){var n=JSON.parse($("#"+e+"_data").val());n.total_amount=parseInt(t.amount),n.orig_amount=parseInt(t.amount),$("#"+e+"_data").val(JSON.stringify(n))}}}),a({status:"SUCCESS"})}}}}};if(t.show_shipping_option||"GOOGLEPAY"!=t.payment_method||delete p.paymentIntent.order.shipping,"checkout_payment"==t.current_page&&(delete p.paymentIntent.order.billing,delete p.paymentIntent.order.shipping),"APPLEPAY"==a&&(delete p.paymentIntent.merchant.partnerId,delete p.paymentIntent.transaction.enforce3d),"product_info"==t.current_page&&0==t.show_shipping_option){var r=JSON.parse($("#"+e+"_data").val());p.paymentIntent.transaction.amount=r.total_amount;var i=JSON.parse($("#nn_article_details").val());p.paymentIntent.order.lineItems=i}if("shopping_cart"==t.current_page&&0==t.show_shipping_option){r=JSON.parse($("#"+e+"_data").val());p.paymentIntent.transaction.amount=r.total_amount}return p}window.addEventListener&&window.addEventListener("load",show_hide),jQuery(document).ready((function(){jQuery(document).ajaxComplete((function(e,a,t){let n=t.url.match(/novalnet_wallet_shipping_data_update_process/i);var o="";1==jQuery("#novalnet_googlepay_enable").val()&&(o=$("#novalnet_googlepay_data").val()),1==jQuery("#novalnet_applepay_enable").val()&&(o=$("#novalnet_applepay_data").val());var l=JSON.parse(o).current_page;if(l&&"shopping_cart"==l&&novalnet_wallet_cart_page(),jQuery("#novalnet_googlepay_wallet_div").length>0&&1==jQuery("#novalnet_googlepay_wallet_div").is(":visible")&&"novalnet_wallet_shipping_data_update_process"!=n){var p={action:"get_variant_product_amount",products_id:jQuery("input[name='products_id']").val(),products_qty:jQuery("input[name='products_qty']").val()},r=[];if($("[name*='modifiers[property]']").each((function(){var e=$(this).val();e&&0!=e&&!r.includes(e)&&r.push(e)})),p.variant_info=r,r.length>0)$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(e){var a=JSON.parse(e);if(""!=a.amount&&void 0!==typeof a.amount){var t=JSON.parse($("#novalnet_googlepay_data").val());t.total_amount=parseInt(a.amount)+parseInt(t.orig_amount),$("#novalnet_googlepay_data").val(JSON.stringify(t))}}});else{p={action:"updated_amount",get_article_details:1};$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(e){var a=JSON.parse(e);if(""!=a.amount&&void 0!==typeof a.amount){var t=JSON.parse($("#novalnet_googlepay_data").val());t.total_amount=parseInt(a.amount),t.orig_amount=parseInt(a.amount),$("#novalnet_googlepay_data").val(JSON.stringify(t))}if(""!=a.article_details){JSON.parse($("#nn_article_details").val());$("#nn_article_details").val(JSON.stringify(a.article_details))}}})}}else if(jQuery("#novalnet_applepay_wallet_div").length>0&&1==jQuery("#novalnet_applepay_wallet_div").is(":visible")&&"novalnet_wallet_shipping_data_update_process"!=n){p={action:"get_variant_product_amount",products_id:jQuery("input[name='products_id']").val(),products_qty:jQuery("input[name='products_qty']").val()},r=[];if($("[name*='modifiers[property]']").each((function(){var e=$(this).val();e&&0!=e&&!r.includes(e)&&r.push(e)})),p.variant_info=r,r.length>0)$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(e){var a=JSON.parse(e);if(""!=a.amount&&void 0!==typeof a.amount){var t=JSON.parse($("#novalnet_applepay_data").val());t.total_amount=parseInt(a.amount)+parseInt(t.orig_amount),$("#novalnet_applepay_data").val(JSON.stringify(t))}}});else{p={action:"updated_amount",get_article_details:1};$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(e){var a=JSON.parse(e);if(""!=a.amount&&void 0!==typeof a.amount){var t=JSON.parse($("#novalnet_applepay_data").val());t.total_amount=parseInt(a.amount),t.orig_amount=parseInt(a.amount),$("#novalnet_applepay_data").val(JSON.stringify(t))}if(""!=a.article_details){JSON.parse($("#nn_article_details").val());$("#nn_article_details").val(JSON.stringify(a.article_details))}}})}}else;}))}));