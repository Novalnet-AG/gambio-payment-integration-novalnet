/**
 * Novalnet payment module
 *
 * This script is used for wallet payments
 *
 * @author     Novalnet AG
 * @copyright  Copyright (c) Novalnet
 * @license    https://www.novalnet.de/payment-plugins/kostenlos/lizenz
 * @link       https://www.novalnet.de
 *
 * Script: novalnet_wallet.js
 */ 
function show_hide(){jQuery("#checkout_payment").on("click",function(){"novalnet_applepay"==jQuery('input[name="payment"]:checked').val()||"novalnet_googlepay"==jQuery('input[name="payment"]:checked').val()?jQuery(".continue_button").hide():jQuery(".continue_button").show()})}function novalnet_wallet_product_page(){1==jQuery("#novalnet_googlepay_enable").val()&&displayWalletButtons("novalnet_googlepay"),1==jQuery("#novalnet_applepay_enable").val()&&displayWalletButtons("novalnet_applepay")}function novalnet_wallet_cart_page(){1==jQuery("#novalnet_googlepay_enable").val()&&displayWalletButtons("novalnet_googlepay"),1==jQuery("#novalnet_applepay_enable").val()&&displayWalletButtons("novalnet_applepay")}function novalnet_checkout_page(a){displayWalletButtons(a)}function displayWalletButtons(a){var t=jQuery("#"+a+"_data").val();t=JSON.parse(t);var e=jQuery("#"+a+"_wallet_div"),n=jQuery("#"+a+"_wallet_button"),o=a+"Instance";(o=NovalnetPayment().createPaymentObject()).setPaymentIntent(self.walletPaymentRequest(a,"novalnet_googlepay"==a?"googlepay":"applepay",t)),o.isPaymentMethodAvailable(function(l){l?(n.empty(),o.addPaymentButton("#"+a+"_wallet_button"),"product_info"==t.current_page?(jQuery(".button-container").css({"margin-top":"30px"}),jQuery("#"+a+"_wallet_button").css({"margin-top":"-20px"}),jQuery("#"+a+"_wallet_button").find("apple-pay-button").css({width:"100%"})):"shopping_cart"==t.current_page?(jQuery("#"+a+"_wallet_button").css({"margin-top":"-10px"}),jQuery("#"+a+"_wallet_button").find("apple-pay-button").css({width:"100%"})):"checkout_payment"==t.current_page&&screen.width<400&&(jQuery("#"+a+"_wallet_div").parent().closest("div").css("margin-left","-15px"),jQuery("#"+a+"_wallet_div").parent().closest("label").css("padding-left","15px")),e.css("display","block")):(e.css("display","none"),jQuery("#novalnet_applepay_checkoutdiv")&&jQuery(".novalnet_applepay").length>0&&jQuery(".novalnet_applepay").hide())})}function walletPaymentRequest(a,t,e){var n={dimensions:{width:"auto",cornerRadius:"APPLEPAY"==(t=t.toUpperCase())?e.applepay_button_radius:"",height:parseInt("GOOGLEPAY"==t?e.googlepay_button_height:e.applepay_button_height)},locale:void 0!==e.lang?e.lang.toLowerCase()+"-"+e.lang:"",type:"GOOGLEPAY"==t?e.googlepay_button_type:e.applepay_button_type,boxSizing:"GOOGLEPAY"==t?"fill":"border-box"};if("shopping_cart"==e.current_page&&("GOOGLEPAY"==t||"APPLEPAY"==t))var o="GOOGLEPAY"==t?jQuery("#nn_googlepay_estotal_label").val():jQuery("#nn_applepay_estotal_label").val();else var o="GOOGLEPAY"==t?jQuery("#nn_googlepay_total_label").val():jQuery("#nn_applepay_total_label").val();var l={clientKey:e.client_key,paymentIntent:{transaction:{amount:void 0!==e.total_amount?e.total_amount:"",currency:void 0!==e.currency?e.currency:"",paymentMethod:t,enforce3d:void 0!==e.enforce_3d?e.enforce_3d:"",environment:void 0!==e.environment?e.environment:""},merchant:{countryCode:void 0!==e.country_code?e.country_code:"",partnerId:"GOOGLEPAY"==t&&void 0!==e.partner_id?e.partner_id:""},custom:{lang:void 0!==e.lang?e.lang.toLowerCase()+"-"+e.lang:""},order:{paymentDataPresent:!1,merchantName:void 0!==e.seller_name?e.seller_name:"",lineItems:"APPLEPAY"==e.payment_method?JSON.parse(jQuery("#nn_apple_article_details").val()):JSON.parse(jQuery("#nn_google_article_details").val()),billing:{requiredFields:["postalAddress","phone","email"]},shipping:{requiredFields:"APPLEPAY"==e.payment_method?["postalAddress","phone","email"]:["postalAddress","phone"],methodsUpdatedLater:"checkout_payment"!=e.current_page},labelText:o},button:n,callbacks:{onProcessCompletion:function(a,n){if("SUCCESS"==a.result.status){if("checkout_payment"==e.current_page){n({status:"SUCCESS",statusText:""}),"GOOGLEPAY"==t?(document.getElementById("nn_google_wallet").value=a.transaction.token,document.getElementById("nn_wallet_doredirect").value=a.transaction.doRedirect):document.getElementById("nn_wallet").value=a.transaction.token;var o=jQuery("div.continue_button :submit");jQuery(o).click()}else{var l={response:a},p={variable_name:l,payment_name:"GOOGLEPAY"==t?"novalnet_googlepay":"novalnet_applepay",payment_page:void 0!==e.current_page?e.current_page:""};1==e.shop_version&&(p.customer_id=e.customer_id,p.loginUrl=e.login_url,p.shippingPage=e.shipping_page),void 0!=e.customer_id&&0==e.customer_id&&"product_info"==e.current_page&&(p.products_qty=jQuery("input[name='products_qty']").val(),p.products_id=jQuery("input[name='products_id']").val(),p.product_amount=jQuery("#nn_product").val()),jQuery.ajax({type:"POST",url:"novalnet_wallet_payment_process.php",data:p,success:function(a){1==(l=JSON.parse(a)).isLogin&&l.login_url&&(window.location.replace(l.login_url),window.location.replace(l.shipping_page)),1==l.isRedirect&&l.redirect_url&&window.location.replace(l.redirect_url),l.return_url&&window.location.replace(l.return_url),n({status:"SUCCESS",statusText:""})},error:function(a){n({status:"ERROR",statusText:a.result.statusText})}})}}},onShippingContactChange:function(a,e){var n={action:"novalnet_shipping_address_update",shippingInfo:JSON.stringify({address:a})};("GOOGLEPAY"==t&&jQuery("#novalnet_googlepay_wallet_button")||"APPLEPAY"==t&&jQuery("#novalnet_applepay_wallet_button"))&&(n.products_qty=jQuery("input[name='products_qty']").val(),n.products_id=jQuery("input[name='products_id']").val(),n.product_amount=jQuery("#nn_product").val());var o=[];$("[name*='modifiers[property]']").each(function(){var a=$(this).val();a&&0!=a&&!o.includes(a)&&o.push(a)}),n.variant_info=o,new Promise(function(a,t){jQuery.ajax({type:"POST",url:"novalnet_wallet_shipping_data_update_process.php",data:n,success:function(t){a(t)}})}).then(function(a){var t=JSON.parse(a),n={};0==t.shipping_address.length?n.methodsNotFound="There are no shipping options available. Please ensure that your address has been entered correctly, or contact us if you need any help.":void 0!=t.shipping_address&&t.shipping_address.length&&(n.amount=t.amount,n.lineItems=t.article_details,n.methods=t.shipping_address,n.defaultIdentifier=t.shipping_address[0].identifier),e(n)})},onShippingMethodChange:function(a,t){var e={action:"novalnet_shipping_method_update",shippingInfo:JSON.stringify({shippingMethod:a})};$.ajax({type:"POST",url:"novalnet_wallet_shipping_data_update_process.php",data:e,success:function(a){var e=JSON.parse(a);t({amount:e.amount,lineItems:e.article_details})}})},onPaymentButtonClicked:function(t){if("product_info"==e.current_page){if(jQuery('button[name="btn-add-to-cart"]').prop("disabled")||jQuery('input[name="btn-add-to-cart"]').prop("disabled"))t({status:"FAILURE"}),alert("Please select some product options before adding this product to your cart.");else if(2==e.product_type){var n={action:"add_virtual_product_in_cart",products_id:jQuery("input[name='products_id']").val(),products_qty:jQuery("input[name='products_qty']").val()},o=[];$("[name*='modifiers[attribute]']").each(function(){if(!0==$(this).prop("checked")){var a=$(this).val();if(a&&0!=a&&!o.includes(a)){var t=$(this).attr("name");o[parseInt(t.match(/\d+/)[0])]=a}}}),n.attribute_info=o,$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:n,success:function(t){var e=JSON.parse(t);if(""!=e.amount&&(e.amount,1)){var n=JSON.parse($("#"+a+"_data").val());n.total_amount=parseInt(e.amount),n.orig_amount=parseInt(e.amount),$("#"+a+"_data").val(JSON.stringify(n))}""!=e.article_details&&($("#nn_apple_article_details").val(JSON.stringify(e.article_details)),$("#nn_google_article_details").val(JSON.stringify(e.article_details)))}}),t({status:"SUCCESS"})}else t({status:"SUCCESS"})}else if("checkout_payment"!=e.current_page){var n={action:"updated_amount"};$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:n,success:function(t){var e=JSON.parse(t);if(""!=e.amount&&(e.amount,1)){var n=JSON.parse($("#"+a+"_data").val());n.total_amount=parseInt(e.amount),n.orig_amount=parseInt(e.amount),$("#"+a+"_data").val(JSON.stringify(n))}}}),t({status:"SUCCESS"})}else t({status:"SUCCESS"})}}}};if((0==e.show_shipping_option&&"GOOGLEPAY"==e.payment_method||0==e.show_shipping_option&&"APPLEPAY"==e.payment_method)&&delete l.paymentIntent.order.shipping,"checkout_payment"==e.current_page&&(delete l.paymentIntent.order.billing,delete l.paymentIntent.order.shipping),"APPLEPAY"==t&&(delete l.paymentIntent.merchant.partnerId,delete l.paymentIntent.transaction.enforce3d),"product_info"==e.current_page&&0==e.show_shipping_option){var p="APPLEPAY"==e.payment_method?JSON.parse(jQuery("#novalnet_applepay_data").val()):JSON.parse(jQuery("#novalnet_googlepay_data").val());l.paymentIntent.transaction.amount=p.total_amount;var i="APPLEPAY"==e.payment_method?JSON.parse(jQuery("#nn_apple_article_details").val()):JSON.parse(jQuery("#nn_google_article_details").val());l.paymentIntent.order.lineItems=i}if("shopping_cart"==e.current_page&&0==e.show_shipping_option&&!0===$(".button-submit").is(":visible")){var p="APPLEPAY"==e.payment_method?JSON.parse(jQuery("#novalnet_applepay_data").val()):JSON.parse(jQuery("#novalnet_googlepay_data").val());l.paymentIntent.transaction.amount=p.total_amount}return l}window.addEventListener&&window.addEventListener("load",show_hide),jQuery(document).ready(function(){jQuery(document).ajaxComplete(function(a,t,e){let n=e.url.match(/novalnet_wallet_shipping_data_update_process/i);var o="";1==jQuery("#novalnet_googlepay_enable").val()&&(o=$("#novalnet_googlepay_data").val()),1==jQuery("#novalnet_applepay_enable").val()&&(o=$("#novalnet_applepay_data").val());var l=JSON.parse(o).current_page;if(l&&"shopping_cart"==l&&!0===$(".button-submit").is(":visible")&&novalnet_wallet_cart_page(),jQuery("#novalnet_googlepay_wallet_div").length>0&&!0==jQuery("#novalnet_googlepay_wallet_div").is(":visible")&&"novalnet_wallet_shipping_data_update_process"!=n){var p={action:"get_variant_product_amount",products_id:jQuery("input[name='products_id']").val(),products_qty:jQuery("input[name='products_qty']").val()},i=[];if($("[name*='modifiers[property]']").each(function(){var a=$(this).val();if(a&&0!=a&&!i.includes(a)){var t=$(this).attr("name");i[parseInt(t.match(/\d+/)[0])]=a}}),p.variant_info=i,i.length>0)$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(a){var t=JSON.parse(a);if(""!=t.amount&&(t.amount,1)){var e=JSON.parse($("#novalnet_googlepay_data").val());e.total_amount=parseInt(t.amount)+parseInt(e.orig_amount),$("#novalnet_googlepay_data").val(JSON.stringify(e))}}});else{var p={action:"updated_amount"};p.get_article_details=1,$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(a){var t=JSON.parse(a);if(""!=t.amount&&(t.amount,1)){var e=JSON.parse($("#novalnet_googlepay_data").val());e.total_amount=parseInt(t.amount),e.orig_amount=parseInt(t.amount),$("#novalnet_googlepay_data").val(JSON.stringify(e))}""!=t.article_details&&($("#nn_apple_article_details").val(JSON.stringify(t.article_details)),$("#nn_google_article_details").val(JSON.stringify(t.article_details)))}})}return}if(jQuery("#novalnet_applepay_wallet_div").length>0&&!0==jQuery("#novalnet_applepay_wallet_div").is(":visible")&&"novalnet_wallet_shipping_data_update_process"!=n){var p={action:"get_variant_product_amount",products_id:jQuery("input[name='products_id']").val(),products_qty:jQuery("input[name='products_qty']").val()},i=[];if($("[name*='modifiers[property]']").each(function(){var a=$(this).val();if(a&&0!=a&&!i.includes(a)){var t=$(this).attr("name");i[parseInt(t.match(/\d+/)[0])]=a}}),p.variant_info=i,i.length>0)$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(a){var t=JSON.parse(a);if(""!=t.amount&&(t.amount,1)){var e=JSON.parse($("#novalnet_applepay_data").val());e.total_amount=parseInt(t.amount)+parseInt(e.orig_amount),$("#novalnet_applepay_data").val(JSON.stringify(e))}}});else{var p={action:"updated_amount"};p.get_article_details=1,$.ajax({url:"novalnet_wallet_shipping_data_update_process.php",type:"POST",data:p,success:function(a){var t=JSON.parse(a);if(""!=t.amount&&(t.amount,1)){var e=JSON.parse($("#novalnet_applepay_data").val());e.total_amount=parseInt(t.amount),e.orig_amount=parseInt(t.amount),$("#novalnet_applepay_data").val(JSON.stringify(e))}""!=t.article_details&&($("#nn_apple_article_details").val(JSON.stringify(t.article_details)),$("#nn_google_article_details").val(JSON.stringify(t.article_details)))}})}return}})});
